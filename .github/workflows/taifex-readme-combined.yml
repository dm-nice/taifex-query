name: Taifex Daily Update with README and Visualization

on:
  schedule:
    - cron: "0 22 * * *"   # UTC 22:00 â†’ å°ç£æ™‚é–“éš”å¤© 06:00
  workflow_dispatch:       # æ‰‹å‹•è§¸ç™¼

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        pip install pandas matplotlib

    - name: Generate visualization and README
      run: |
        python - <<'EOF'
        import os, glob
        import pandas as pd
        import matplotlib.pyplot as plt
        from datetime import datetime

        # === 1. ç”¢ç”Ÿç›®éŒ„çµæ§‹ ===
        def tree(dir_path, prefix=""):
            entries = sorted(os.listdir(dir_path))
            lines = []
            for i, entry in enumerate(entries):
                path = os.path.join(dir_path, entry)
                connector = "â”œâ”€â”€ " if i < len(entries)-1 else "â””â”€â”€ "
                lines.append(prefix + connector + entry)
                if os.path.isdir(path) and not entry.startswith(".git"):
                    extension = "â”‚   " if i < len(entries)-1 else "    "
                    lines.extend(tree(path, prefix + extension))
            return lines

        structure = "\n".join(tree("."))

        # === 2. æ‰¾æœ€æ–° CSV ä¸¦ç”¢ç”ŸæŠ˜ç·šåœ– ===
        files = glob.glob("data/*trading.csv")
        latest_date = "å°šç„¡è³‡æ–™"
        if files:
            latest = max(files, key=os.path.getctime)
            df = pd.read_csv(latest)
            latest_date = df["æ—¥æœŸ"].iloc[-1]

            plt.figure(figsize=(10,5))
            plt.plot(df["æ—¥æœŸ"], df["å¤–è³‡æ·¨é¡"], marker="o", label="å¤–è³‡æ·¨é¡")
            plt.title("å¤–è³‡æ·¨é¡è¶¨å‹¢")
            plt.xlabel("æ—¥æœŸ")
            plt.ylabel("æ·¨é¡")
            plt.legend()
            plt.grid(True)
            os.makedirs("visualize", exist_ok=True)
            plt.savefig("visualize/foreign_net_trend.png")

        # === 3. æ›´æ–° README ===
        with open("README.md", "w", encoding="utf-8") as f:
            f.write("# TAIFEX è‡ªå‹•åŒ–æŸ¥è©¢å°ˆæ¡ˆï¼ˆæ¯æ—¥æ›´æ–°ï¼‰\n\n")
            f.write(f"ğŸ“… æœ€æ–°æ›´æ–°æ—¥æœŸï¼š{latest_date}\n\n")
            f.write("## ğŸ“‚ å°ˆæ¡ˆç›®éŒ„çµæ§‹\n\n")
            f.write("```\n" + structure + "\n```\n\n")
            f.write("## ğŸ“Š å¤–è³‡æ·¨é¡è¶¨å‹¢åœ–\n\n")
            f.write("![å¤–è³‡æ·¨é¡è¶¨å‹¢](visualize/foreign_net_trend.png)\n\n")
            f.write("æœ¬å°ˆæ¡ˆæ¯å¤©æ—©ä¸Š 06:00 è‡ªå‹•æŠ“å–å‰ä¸€äº¤æ˜“æ—¥è³‡æ–™ï¼Œä¸¦æ›´æ–°ç›®éŒ„çµæ§‹èˆ‡æŠ˜ç·šåœ–ã€‚")
        EOF

    - name: Commit and push results
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md visualize/*.png data/*.csv
        git commit -m "docs: è‡ªå‹•æ›´æ–° README ç›®éŒ„çµæ§‹èˆ‡æŠ˜ç·šåœ–"
        git push
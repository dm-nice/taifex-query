# f01_fetcher é–‹ç™¼è¦æ ¼

> **æ¨¡çµ„ä»£è™Ÿ**: `f01_fetcher`  
> **è³‡æ–™ä¾†æº**: å°ç£æœŸè²¨äº¤æ˜“æ‰€ (TAIFEX)  
> **é›£åº¦**: â­â­â˜†â˜†â˜† (2/5)

## ğŸ“‹ å°ˆæ¡ˆç›®æ¨™
æŠ“å– **å°æŒ‡æœŸè²¨å¤–è³‡çš„æœªå¹³å€‰æ·¨å£æ•¸ (OI)**ã€‚

## ğŸ“‚ äº¤ä»˜æª”æ¡ˆ
è«‹ä¾ç…§ä»¥ä¸‹å‘½åè¦å‰‡å»ºç«‹æª”æ¡ˆï¼š
- **æª”å**: `f01_fetcher_dev.py`
- **MODULE è®Šæ•¸**: `"f01_fetcher_dev"`

## ğŸ“Š è³‡æ–™ä¾†æºè¦æ ¼
- **URL**: `https://www.taifex.com.tw/cht/3/futContractsDate?queryType=1&marketCode=0&date=YYYY/MM/DD`
- **æŠ“å–æ–¹å¼**: HTML è¡¨æ ¼çˆ¬èŸ² (å»ºè­°ä½¿ç”¨ `requests` + `pandas` æˆ– `BeautifulSoup`)
- **è¡¨æ ¼ç‰¹å¾µ**: å¤šå±¤è¡¨é ­ (MultiIndex)ï¼Œéœ€ç²¾ç¢ºå®šä½ã€Œå¤–è³‡ã€èº«ä»½åˆ¥
- **æ›´æ–°é »ç‡**: æ¯æ—¥ï¼ˆäº¤æ˜“æ—¥ï¼‰

## ğŸ” éœ€æŠ“å–çš„æ¬„ä½å®šç¾©

| é¡åˆ¥ | æ¬„ä½åç¨± | èªªæ˜ | è³‡æ–™é¡å‹ | ç¯„ä¾‹å€¼ |
|------|---------|------|---------|--------|
| ç¯©é¸æ¢ä»¶ | èº«ä»½åˆ¥ | ç”¨æ–¼ç¯©é¸ **ã€Œå¤–è³‡åŠé™¸è³‡ã€** çš„è¡Œ | str | "å¤–è³‡åŠé™¸è³‡" |
| ç›®æ¨™è³‡æ–™ | æœªå¹³å€‰é¤˜é¡ > å¤šæ–¹ > å£æ•¸ | å¤–è³‡å¤šæ–¹æœªå¹³å€‰å£æ•¸ | int | 18808 |
| ç›®æ¨™è³‡æ–™ | æœªå¹³å€‰é¤˜é¡ > ç©ºæ–¹ > å£æ•¸ | å¤–è³‡ç©ºæ–¹æœªå¹³å€‰å£æ•¸ | int | 48032 |
| è¨ˆç®—æ¬„ä½ | å¤šç©ºæ·¨é¡ | å¤šæ–¹å£æ•¸ - ç©ºæ–¹å£æ•¸ | int | -29224 |

## âš™ï¸ é–‹ç™¼å‰é ˆçŸ¥

### æ¸¬è©¦æ•¸æ“šèˆ‡å·¥å…·
- **æ¸¬è©¦æ•¸æ“š**: è«‹ä½¿ç”¨ä¸‹æ–¹ã€ŒğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ã€ç« ç¯€æä¾›çš„æ¸¬è©¦æ—¥æœŸ (`2025-12-02`, `2025-11-30`) é€²è¡Œé–‹ç™¼
- **API æ¸¬è©¦å·¥å…·**: å»ºè­°ä½¿ç”¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12) æª¢è¦–ç¶²é çµæ§‹ï¼Œç„¡éœ€é¡å¤–å·¥å…·
- **ä¾è³´å¥—ä»¶**: å°ˆæ¡ˆå·²å®‰è£å¸¸ç”¨å¥—ä»¶ (`requests`, `pandas`, `beautifulsoup4`)ï¼Œè‹¥éœ€å…¶ä»–å¥—ä»¶è«‹åœ¨äº¤ä»˜æ™‚è¨»æ˜

### éŒ¯èª¤è™•ç†éœ€æ±‚
> [!IMPORTANT]
> **å¿…é ˆè™•ç†ä»¥ä¸‹éŒ¯èª¤æƒ…å¢ƒ**ï¼š
> 1. **ç¶²è·¯éŒ¯èª¤**: é€£ç·šé€¾æ™‚ã€HTTP éŒ¯èª¤ (ä½¿ç”¨ `timeout=10` åƒæ•¸)
> 2. **è³‡æ–™æ ¼å¼éŒ¯èª¤**: æ‰¾ä¸åˆ°ç›®æ¨™æ¬„ä½ã€è³‡æ–™ç‚ºç©ºã€MultiIndex è§£æå¤±æ•—
> 3. **éäº¤æ˜“æ—¥**: é€±æœ«æˆ–åœ‹å®šå‡æ—¥ç„¡è³‡æ–™æ™‚ï¼Œå›å‚³ `status="fail"` ä¸¦è¨»æ˜ `"éäº¤æ˜“æ—¥ï¼Œç„¡è³‡æ–™"`
> 
> **æ‰€æœ‰éŒ¯èª¤éƒ½å¿…é ˆæ•æ‰ä¸¦å›å‚³ `FetchResult` ç‰©ä»¶ï¼Œä¸å¯ç›´æ¥æ‹‹å‡º Exceptionã€‚**

### èªç³»æ”¯æ´
- **åƒ…éœ€æ”¯æ´ç¹é«”ä¸­æ–‡**: æ‰€æœ‰ data key åç¨±ã€summaryã€error è¨Šæ¯çš†ä½¿ç”¨ç¹é«”ä¸­æ–‡
- **ç„¡éœ€å¤šèªç³»**: æœ¬å°ˆæ¡ˆä¸éœ€è¦è‹±æ–‡æˆ–å…¶ä»–èªè¨€æ”¯æ´

### é–‹ç™¼ç’°å¢ƒ
- **Python ç‰ˆæœ¬**: 3.12+
- **è™›æ“¬ç’°å¢ƒ**: è«‹ä½¿ç”¨å°ˆæ¡ˆæä¾›çš„ `venv32` è™›æ“¬ç’°å¢ƒ
- **æ¸¬è©¦æ¡†æ¶**: pytest (å·²å®‰è£)

## ğŸ› ï¸ é–‹ç™¼è¦ç¯„

### 1. ç¹¼æ‰¿èˆ‡ä»‹é¢
æ‚¨çš„ç¨‹å¼ç¢¼å¿…é ˆç¹¼æ‰¿ `modules.base.BaseFetcher` ä¸¦å¯¦ä½œ `fetch` æ–¹æ³•ã€‚

```python
from modules.base import BaseFetcher, FetchResult

MODULE = "f01_fetcher_dev"  # å¿…é ˆèˆ‡æª”åä¸€è‡´ (ä¸å« .py)

class TaifexFetcher(BaseFetcher):
    def fetch(self, date: str) -> dict:
        # å¯¦ä½œæŠ“å–é‚è¼¯
        # ...
        return FetchResult(
            module=MODULE,
            date=date,
            status="success",  # æˆ– "fail"
            data={
                "å¤–è³‡å¤šæ–¹å£æ•¸": 18808,
                "å¤–è³‡ç©ºæ–¹å£æ•¸": 48032,
                "å¤–è³‡å¤šç©ºæ·¨é¡": -29224
            },
            summary="F1: å°æŒ‡æœŸå¤–è³‡æ·¨é¡ï¼š-29224ï¼ˆå¤šï¼š18808ï¼Œç©ºï¼š48032ï¼‰",
            source="TAIFEX"
        ).to_dict()
```

> [!CAUTION]
> **é‡è¦ï¼šdata çš„ key åç¨±å¿…é ˆå®Œå…¨ä¸€è‡´ï¼**
> - âœ… æ­£ç¢ºï¼š`"å¤–è³‡å¤šæ–¹å£æ•¸"`, `"å¤–è³‡ç©ºæ–¹å£æ•¸"`, `"å¤–è³‡å¤šç©ºæ·¨é¡"`
> - âŒ éŒ¯èª¤ï¼š`"å¤–è³‡å¤šå–®å£æ•¸"`, `"å¤–è³‡ç©ºå–®å£æ•¸"` (ç³»çµ±æœƒç„¡æ³•è®€å–è³‡æ–™)
> 
> è«‹å‹™å¿…ä½¿ç”¨ä¸Šæ–¹ç¯„ä¾‹ä¸­çš„ **exact key åç¨±**ï¼Œå¦å‰‡é©—æ”¶æœƒå¤±æ•—ã€‚

### 2. éŒ¯èª¤è™•ç†
- è‹¥æŠ“å–å¤±æ•—æˆ–ç„¡è³‡æ–™ï¼Œè«‹å›å‚³ `status="fail"` ä¸¦åœ¨ `error` æ¬„ä½è¨»æ˜åŸå› ã€‚
- è«‹å‹¿ç›´æ¥æ‹‹å‡º Exception å°è‡´ç¨‹å¼å´©æ½°ï¼Œæ‡‰æ•æ‰ç•°å¸¸ä¸¦å›å‚³éŒ¯èª¤çµæœã€‚

```python
try:
    # æŠ“å–é‚è¼¯
    url = f"https://www.taifex.com.tw/cht/3/futContractsDate?queryType=1&marketCode=0&date={date.replace('-', '/')}"
    resp = requests.get(url, timeout=10)
    # ...
except Exception as e:
    return FetchResult(
        module=MODULE,
        date=date,
        status="fail",
        error=str(e),
        data={},
        source="TAIFEX"
    ).to_dict()
```

## ğŸ¯ ç‰¹æ®Šè™•ç†é‚è¼¯

### 1. å¤šå±¤è¡¨é ­ (MultiIndex) è™•ç†
å°æŒ‡æœŸçš„è¡¨æ ¼ä½¿ç”¨ MultiIndex çµæ§‹ï¼Œæ¬„ä½åç¨±æ˜¯ tuple æ ¼å¼ï¼Œä¾‹å¦‚ï¼š
```python
('Unnamed: 2_level_0', 'èº«ä»½åˆ¥')
('æœªå¹³å€‰é¤˜é¡', 'å¤šæ–¹', 'å£æ•¸')
```

å»ºè­°ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å°‹æ‰¾æ¬„ä½ï¼š
```python
# æ‰¾åˆ°èº«ä»½åˆ¥æ¬„ä½
trader_col = None
for col in df.columns:
    if any('èº«ä»½åˆ¥' in str(c) for c in col):
        trader_col = col
        break
```

### 2. èº«ä»½åˆ¥åç¨±
å°æŒ‡æœŸçš„èº«ä»½åˆ¥æ¬„ä½é€šå¸¸é¡¯ç¤ºç‚º **ã€Œå¤–è³‡åŠé™¸è³‡ã€**ï¼Œè€Œä¸æ˜¯ã€Œå¤–è³‡ã€ã€‚

å»ºè­°å„ªå…ˆæ‰¾ã€Œå¤–è³‡åŠé™¸è³‡ã€ï¼Œæ‰¾ä¸åˆ°å†å˜—è©¦ã€Œå¤–è³‡ã€ï¼š
```python
foreign_rows = df[df[trader_col] == 'å¤–è³‡åŠé™¸è³‡']
if len(foreign_rows) == 0:
    foreign_rows = df[df[trader_col] == 'å¤–è³‡']
```

### 3. è³‡æ–™å‹åˆ¥è½‰æ›
å¾ç¶²é æŠ“å–çš„è³‡æ–™å¯èƒ½åŒ…å«åƒåˆ†ä½é€—è™Ÿï¼Œéœ€è¦ç§»é™¤å¾Œè½‰ç‚º intï¼š
```python
def to_int(v):
    if pd.isna(v):
        return 0
    return int(str(v).replace(',', '').strip())
```

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦æ—¥æœŸèˆ‡é æœŸçµæœ
è«‹ä½¿ç”¨ä»¥ä¸‹æ—¥æœŸé€²è¡Œæ¸¬è©¦ï¼Œç¢ºä¿çµæœç¬¦åˆé æœŸï¼š

| æ¸¬è©¦æ—¥æœŸ | é æœŸç‹€æ…‹ | é æœŸè³‡æ–™ | å‚™è¨» |
|---------|---------|---------|------|
| 2025-12-02 | success | å¤–è³‡å¤šæ–¹å£æ•¸: 18808<br>å¤–è³‡ç©ºæ–¹å£æ•¸: 48032<br>å¤–è³‡å¤šç©ºæ·¨é¡: -29224 | æ­£å¸¸äº¤æ˜“æ—¥ |
| 2025-11-30 | fail | - | é€±å…­ï¼Œç„¡äº¤æ˜“ |

### è‡ªè¡Œæ¸¬è©¦ (å¿…åš)
è«‹ç¢ºä¿æ‚¨çš„ç’°å¢ƒå·²å®‰è£ `pytest`ã€‚åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼š

```bash
# æ¸¬è©¦æ‚¨çš„æ¨¡çµ„
pytest dev/f01_fetcher_dev.py
```

**é©—æ”¶æ¨™æº–ï¼š**
1. æ¸¬è©¦çµæœå¿…é ˆç‚º **PASSED**ã€‚
2. ç”¢å‡ºçš„ JSON æ ¼å¼å¿…é ˆå®Œå…¨ç¬¦åˆä¸Šè¿°å®šç¾©ã€‚
3. åŸ·è¡Œ `python run.py 2025-12-02 dev --module f01_fetcher_dev` å¾Œï¼Œ`data/` ç›®éŒ„ç”¢ç”Ÿçš„ JSON æª”æ¡ˆæ•¸å€¼ä¸æ˜¯ "-"ã€‚

## ğŸ“¦ äº¤ä»˜å…§å®¹
1. `f01_fetcher_dev.py` (æ‚¨çš„å¯¦ä½œæª”æ¡ˆ)
2. ä»»ä½•æ–°å¢çš„ä¾è³´å¥—ä»¶ (è‹¥æœ‰ä½¿ç”¨æ¨™æº–åº«ä»¥å¤–çš„å¥—ä»¶ï¼Œè«‹è¨»æ˜)

## âš ï¸ å¤–åŒ…æ³¨æ„äº‹é … (Q&A)

é‡å°å¤–åŒ…å•†å¸¸è¦‹å•é¡Œï¼Œåœ¨æ­¤çµ±ä¸€èªªæ˜ï¼š

1. **Q: æ˜¯å¦éœ€è¦é¡å¤–çš„æ¸¬è©¦æ•¸æ“šæˆ– API æ¸¬è©¦å·¥å…·ï¼Ÿ**
   - **A**: ä¸éœ€è¦ã€‚
     - æ¸¬è©¦æ•¸æ“šï¼šè«‹ç›´æ¥ä½¿ç”¨æœ¬è¦æ ¼æ›¸ã€ŒğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ã€ç« ç¯€æä¾›çš„æ—¥æœŸã€‚
     - å·¥å…·ï¼šä½¿ç”¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12) è§€å¯Ÿ Network è«‹æ±‚å³å¯ã€‚

2. **Q: æ˜¯å¦æœ‰ç‰¹å®šçš„éŒ¯èª¤è™•ç†éœ€æ±‚ï¼ˆä¾‹å¦‚ï¼šç¶²è·¯éŒ¯èª¤ã€æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼‰ï¼Ÿ**
   - **A**: æ˜¯ï¼Œéå¸¸é‡è¦ã€‚
     - è«‹åƒé–±ã€Œâš™ï¸ é–‹ç™¼å‰é ˆçŸ¥ > éŒ¯èª¤è™•ç†éœ€æ±‚ã€ç« ç¯€ã€‚
     - å¿…é ˆæ•æ‰ ConnectionError, Timeout, ValueError ç­‰ç•°å¸¸ã€‚
     - **ç¦æ­¢**ç›´æ¥è®“ç¨‹å¼ Crashï¼Œå¿…é ˆå›å‚³ `status="fail"` çš„ `FetchResult`ã€‚

3. **Q: æ˜¯å¦éœ€è¦æ”¯æ´å¤šèªç³»ï¼ˆä¾‹å¦‚ï¼šä¸­æ–‡èˆ‡è‹±æ–‡ï¼‰ï¼Ÿ**
   - **A**: ä¸éœ€è¦ã€‚
     - æœ¬å°ˆæ¡ˆåƒ…éœ€æ”¯æ´ **ç¹é«”ä¸­æ–‡**ã€‚
     - éŒ¯èª¤è¨Šæ¯ã€Summaryã€Data Key çš†ä½¿ç”¨ä¸­æ–‡å³å¯ã€‚

## ğŸ“ åƒè€ƒè³‡æ–™
- [å°ç£æœŸè²¨äº¤æ˜“æ‰€ - ä¸‰å¤§æ³•äººäº¤æ˜“è³‡è¨Š](https://www.taifex.com.tw/cht/3/futContractsDate)

# Taifex Fetcher é–‹ç™¼æŒ‡å—

æ­¡è¿ï¼æœ¬æŒ‡å—å°‡å”åŠ©æ‚¨é–‹ç™¼ Taifex è³‡æ–™æŠ“å–æ¨¡çµ„ã€‚

## ğŸ“‚ å°ˆæ¡ˆçµæ§‹

```text
project_root/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ base.py              # åŸºç¤é¡åˆ¥ (BaseFetcher, FetchResult)
â”‚   â””â”€â”€ f01_fetcher.py       # æ­£å¼ä¸Šç·šçš„æ¨¡çµ„
â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ README.md            # æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ specs/               # å„æ¨¡çµ„çš„è¦æ ¼æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ f01_fetcher_spec.md
â”‚   â”‚   â”œâ”€â”€ f02_fetcher_spec.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ _template.py         # é–‹ç™¼ç¯„æœ¬
â”‚   â””â”€â”€ f01_fetcher_dev.py   # é–‹ç™¼ä¸­çš„æ¨¡çµ„
â”œâ”€â”€ tests/                   # æ¸¬è©¦æª”æ¡ˆ
â”œâ”€â”€ data/                    # è¼¸å‡ºè³‡æ–™
â””â”€â”€ logs/                    # åŸ·è¡Œæ—¥èªŒ
```

## ğŸ¯ é–‹ç™¼æµç¨‹

### 1. é¸æ“‡ä»»å‹™
å¾ `dev/specs/` ç›®éŒ„ä¸­é¸æ“‡ä¸€å€‹è¦æ ¼æ–‡ä»¶ï¼Œä¾‹å¦‚ `f01_fetcher_spec.md`ã€‚

### 2. å»ºç«‹é–‹ç™¼æª”æ¡ˆ
è¤‡è£½ `dev/_template.py` ä¸¦é‡æ–°å‘½åï¼š
```bash
cp dev/_template.py dev/f01_fetcher_dev.py
```

### 3. å¯¦ä½œ fetch æ–¹æ³•
æ ¹æ“šè¦æ ¼æ–‡ä»¶çš„è¦æ±‚å¯¦ä½œ `fetch(date: str) -> dict` æ–¹æ³•ã€‚

**é‡è¦è¦ç¯„**ï¼š
- å¿…é ˆç¹¼æ‰¿ `modules.base.BaseFetcher`
- æª”åå¿…é ˆèˆ‡ `MODULE` è®Šæ•¸ä¸€è‡´ï¼ˆä¾‹å¦‚ `f01_fetcher_dev.py` â†’ `MODULE = "f01_fetcher_dev"`ï¼‰
- ä½¿ç”¨ `FetchResult` ç‰©ä»¶å›å‚³è³‡æ–™ï¼Œç¢ºä¿æ ¼å¼æ­£ç¢º

### 4. æœ¬åœ°æ¸¬è©¦
```bash
# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
.\venv32\Scripts\Activate.ps1

# åŸ·è¡Œ pytest æ¸¬è©¦
pytest dev/f01_fetcher_dev.py

# åŸ·è¡Œå¯¦éš›æŠ“å–æ¸¬è©¦
python run.py 2025-12-02 dev --module f01_fetcher_dev
```

### 5. äº¤ä»˜
ç¢ºèªæ¸¬è©¦é€šéå¾Œï¼Œå°‡æª”æ¡ˆæäº¤è‡³ `dev/` ç›®éŒ„ã€‚

## ğŸ“‹ è³‡æ–™æ ¼å¼è¦ç¯„

### å¿…é ˆä½¿ç”¨çš„ data key åç¨±
> [!CAUTION]
> **é€™äº› key åç¨±å¿…é ˆå®Œå…¨ä¸€è‡´ï¼Œå¦å‰‡ç³»çµ±ç„¡æ³•è®€å–è³‡æ–™ï¼**

```python
data = {
    "å¤–è³‡å¤šæ–¹å£æ•¸": 18808,      # âœ… æ­£ç¢º
    "å¤–è³‡ç©ºæ–¹å£æ•¸": 48032,      # âœ… æ­£ç¢º
    "å¤–è³‡å¤šç©ºæ·¨é¡": -29224      # âœ… æ­£ç¢º
}

# âŒ éŒ¯èª¤ç¯„ä¾‹ï¼ˆå¸¸è¦‹éŒ¯èª¤ï¼‰
data = {
    "å¤–è³‡å¤šå–®å£æ•¸": 18808,      # âŒ æœƒå°è‡´è³‡æ–™ç„¡æ³•è®€å–
    "å¤–è³‡ç©ºå–®å£æ•¸": 48032       # âŒ æœƒå°è‡´è³‡æ–™ç„¡æ³•è®€å–
}
```

### å®Œæ•´å›å‚³æ ¼å¼
```python
return FetchResult(
    module=MODULE,
    date=date,
    status="success",  # æˆ– "fail"
    data={
        "å¤–è³‡å¤šæ–¹å£æ•¸": 18808,
        "å¤–è³‡ç©ºæ–¹å£æ•¸": 48032,
        "å¤–è³‡å¤šç©ºæ·¨é¡": -29224
    },
    summary="F1: å°æŒ‡æœŸå¤–è³‡æ·¨é¡ï¼š-29224ï¼ˆå¤šï¼š18808ï¼Œç©ºï¼š48032ï¼‰",
    source="TAIFEX"
).to_dict()
```

## ğŸ§ª æ¸¬è©¦èˆ‡é©—æ”¶

### è‡ªå‹•åŒ–æ¸¬è©¦
æ¯å€‹æ¨¡çµ„éƒ½å¿…é ˆé€šé `pytest` æ¸¬è©¦ï¼š
```bash
pytest dev/your_module_dev.py
```

æ¸¬è©¦æœƒè‡ªå‹•æª¢æŸ¥ï¼š
- âœ… æª”åèˆ‡ MODULE è®Šæ•¸æ˜¯å¦ä¸€è‡´
- âœ… æ˜¯å¦æ­£ç¢ºç¹¼æ‰¿ BaseFetcher
- âœ… fetch æ–¹æ³•æ˜¯å¦å­˜åœ¨
- âœ… å›å‚³æ ¼å¼æ˜¯å¦æ­£ç¢º

### é©—æ”¶æ¨™æº–
1. **pytest æ¸¬è©¦é€šé**ï¼ˆå¿…é ˆç‚º PASSEDï¼‰
2. **å¯¦éš›è³‡æ–™æŠ“å–æˆåŠŸ**ï¼ˆåŸ·è¡Œ `run.py` å¾Œï¼Œ`data/` ç›®éŒ„ç”¢ç”Ÿæ­£ç¢ºçš„ JSON æª”æ¡ˆï¼‰
3. **è³‡æ–™å…§å®¹æ­£ç¢º**ï¼ˆæ•¸å€¼ä¸æ˜¯ "-"ï¼Œä¸”èˆ‡ç¶²ç«™è³‡æ–™ä¸€è‡´ï¼‰

## âš ï¸ å¸¸è¦‹éŒ¯èª¤

### 1. æª”åèˆ‡ MODULE è®Šæ•¸ä¸ä¸€è‡´
```python
# æª”åï¼šf01_fetcher_dev.py
MODULE = "f02_fetcher_dev"  # âŒ éŒ¯èª¤ï¼æœƒå°è‡´ pytest å¤±æ•—
MODULE = "f01_fetcher_dev"  # âœ… æ­£ç¢º
```

### 2. data key åç¨±éŒ¯èª¤
è«‹åƒè€ƒä¸Šæ–¹ã€Œè³‡æ–™æ ¼å¼è¦ç¯„ã€ç« ç¯€ã€‚

### 3. æœªè™•ç†ç•°å¸¸
```python
# âŒ éŒ¯èª¤ï¼šç›´æ¥æ‹‹å‡ºç•°å¸¸
def fetch(self, date: str) -> dict:
    resp = requests.get(url)  # å¯èƒ½æœƒæ‹‹å‡ºç•°å¸¸
    return result

# âœ… æ­£ç¢ºï¼šæ•æ‰ç•°å¸¸ä¸¦å›å‚³ fail ç‹€æ…‹
def fetch(self, date: str) -> dict:
    try:
        resp = requests.get(url, timeout=10)
        # ...
        return FetchResult(..., status="success").to_dict()
    except Exception as e:
        return FetchResult(
            module=MODULE,
            date=date,
            status="fail",
            error=str(e),
            data={},
            source="TAIFEX"
        ).to_dict()
```

### 4. èº«ä»½åˆ¥åç¨±éŒ¯èª¤
å°æŒ‡æœŸçš„èº«ä»½åˆ¥æ¬„ä½é€šå¸¸é¡¯ç¤ºç‚º **ã€Œå¤–è³‡åŠé™¸è³‡ã€**ï¼Œè€Œä¸æ˜¯ã€Œå¤–è³‡ã€ã€‚

```python
# âœ… æ­£ç¢ºï¼šå„ªå…ˆæ‰¾ã€Œå¤–è³‡åŠé™¸è³‡ã€
foreign_rows = df[df[trader_col] == 'å¤–è³‡åŠé™¸è³‡']
if len(foreign_rows) == 0:
    foreign_rows = df[df[trader_col] == 'å¤–è³‡']  # å‚™ç”¨æ–¹æ¡ˆ
```

## ğŸ“ æ”¯æ´

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹åƒè€ƒï¼š
1. å„æ¨¡çµ„çš„è¦æ ¼æ–‡ä»¶ï¼ˆ`dev/specs/`ï¼‰
2. é–‹ç™¼ç¯„æœ¬ï¼ˆ`dev/_template.py`ï¼‰
3. å·²ä¸Šç·šçš„æ¨¡çµ„ç¯„ä¾‹ï¼ˆ`modules/f01_fetcher.py`ï¼‰

##### Taifex 專案開發討論記錄

> **建立日期**: 2025-12-04
> **最後更新**: 2025-12-06
> **用途**: 整合 Claude 跨討論組的討論內容與重要決策

---

#### 📖 使用說明

### 如何使用本文件

1. **記錄討論** - Claude 討論完後，整理重點並追加到對應日期區塊
2. **讀取歷史** - 在 Claude 對話框輸入：「讀取 Claude跨討論組_log.md 的最新討論內容」
3. **自動更新** - 在 Claude 完成任務後輸入：「把剛才的工作記錄追加到 Claude跨討論組_log.md」

---

#### 🎯 專案核心資訊

### 專案架構

**run.py 核心機制**：
- 動態載入模組（`importlib`）
- 統一執行介面（`fetch(date: str) -> str`）
- 集中輸出到 `data/` 目錄（`.txt` 文字格式）
- 中文使用者介面

**fetcher 模組規範**（v4.0 統一文字格式）：
- ✅ 必須提供 `fetch(date: str) -> str`
- ✅ 回傳統一文字格式：`[ YYYY.MM.DD  FXX{描述}   source: {來源} ]`
- ✅ 錯誤格式：`[ YYYY.MM.DD  FXX 錯誤: {訊息}   source: {來源} ]`
- ✅ 完整錯誤處理（不拋出例外）
- ✅ 支援獨立測試

### 重要路徑

```
專案根目錄: C:\Taifex\
正式模組:   C:\Taifex\modules\
開發模組:   C:\Taifex\dev\
輸出目錄:   C:\Taifex\data\
規範文件:   C:\Taifex\dev\共同開發規範書_V1.md
開發指南:   C:\Taifex\dev\README.md
```

### 常用指令

```bash
# 測試單一模組（獨立執行）
python modules/f01_fetcher.py 2025-12-03

# 驗收模式（測試 dev/ 模組）
python run.py 2025-12-03 dev --module f01_fetcher_dev

# 正式模式（執行 modules/ 模組）
python run.py 2025-12-03

# 顯示說明
python run.py --help
```

---

#### 📚 關鍵概念速查

### 統一文字格式（v4.0）

**成功格式**：
```
[ YYYY.MM.DD  FXX{描述}   source: {來源} ]
```

**範例**：
```
[ 2025.12.03  F01台指期外資淨額 -29,439 口（多方 19,214，空方 48,653）   source: TAIFEX ]
```

**錯誤格式**：
```
[ YYYY.MM.DD  FXX 錯誤: {錯誤訊息}   source: {來源} ]
```

**範例**：
```
[ 2025.11.30  F01 錯誤: 該日無交易資料（可能是假日或休市日）   source: TAIFEX ]
```

### 四大核心規範

1. ✅ **回傳類型**：必須是 `str`（統一文字格式）
2. ✅ **錯誤處理**：所有錯誤都轉換為文字格式，不拋出例外
3. ✅ **日期格式**：輸入 `YYYY-MM-DD` → 輸出 `YYYY.MM.DD`
4. ✅ **模組代號**：大寫（F01, F02...）

---

#### 📊 專案狀態

### 模組開發進度

| 模組 | 功能 | 狀態 | 輸出格式 |
|------|------|------|----------|
| F01 | 台指期外資未平倉 | ✅ 正式上線 | v4.0 統一文字格式 |
| F14 | 台指期貨收盤價 | 🔄 開發中 | v4.0 統一文字格式 |
| F02-F13 | 待開發 | ⏸️ 計劃中 | - |
| F15-F20 | 待開發 | ⏸️ 計劃中 | - |

### 文件完成度

| 文件 | 狀態 | 備註 |
|------|------|------|
| README.md | ✅ 完成 | 專案入口 |
| dev/README.md | ✅ 完成 | 開發指南 |
| 共同開發規範書_V1.md | ✅ 完成 | 含快速參考 |
| _template.py | ✅ 完成 | v4.0 範本 |
| _template_spec.md | ✅ 完成 | v4.0 範本 |
| CLAUDE_CONFIG.md | ✅ 完成 | Claude Code 配置 |

---

#### 📝 重要決策記錄

### 2025-12-06 - 升級到統一文字格式 v4.0

**背景**：
- 原系統使用 dict/JSON 格式輸出
- 需要更簡潔、人類可讀的輸出格式

**決策**：
1. ✅ 移除 `base.py`（BaseFetcher, FetchResult）
2. ✅ 所有模組改為回傳 `str`（統一文字格式）
3. ✅ 輸出檔案從 `.json` 改為 `.txt`
4. ✅ 更新所有範本和文件到 v4.0

**影響**：
- 所有新模組必須遵循 v4.0 規範
- 舊模組需要升級（run.py 向後兼容處理）

### 2025-12-04 - F01 日期參數限制

**問題**：
- TAIFEX `futContractsDate` API 忽略日期參數
- 無論輸入什麼日期，都回傳最後交易日資料

**決策**：
- ✅ 保留現有功能，清楚記錄限制
- ✅ 在 docstring 和註解中說明問題
- 📋 未來若需歷史查詢 → 考慮 Selenium 方案

### 2025-12-04 - 文件整合與簡化

**問題**：
- 文件重複、結構混亂
- PROJECT_SPEC.md 與共同開發規範書重疊

**決策**：
1. ✅ 刪除 CHANGELOG.md（系統開發中）
2. ✅ 刪除 PROJECT_SPEC.md（內容併入共同開發規範書）
3. ✅ 將 PROJECT_SPEC 內容作為「快速參考」章節
4. ✅ 保持單一真實來源（共同開發規範書）

---

#### 🔄 下一步計畫

### 短期（本週）
- [ ] F14 模組實現真實資料抓取邏輯
- [ ] 測試 F14 模組穩定性
- [ ] 準備 F02-F03 模組規劃

### 中期（下週-下月）
- [ ] 評估是否需要 Selenium 升級（歷史日期查詢）
- [ ] 建立自動化測試套件
- [ ] 新增資料驗證層

### 長期
- [ ] 自動排程執行（每日定時抓取）
- [ ] 資料持久化與分析
- [ ] 可視化儀表板

---

#### 💡 經驗分享

### 關於統一文字格式（v4.0）

**優點**：
- ✅ 簡潔易讀，適合人類閱讀
- ✅ 無需 JSON 解析器
- ✅ 直接支援文字處理工具（grep, awk 等）
- ✅ 減少依賴（不需要 pydantic）

**注意事項**：
- ⚠️ 模組內部仍可使用 dict 處理邏輯
- ⚠️ 最後必須轉換為文字格式
- ⚠️ 錯誤處理必須完整，不能拋出例外

### 關於文件撰寫

**經驗**：
- 📋 共同規範書：避免重複，集中管理
- 📋 個別規範書：只寫模組特有部分
- 📋 範本優先：提供現成起點
- 📋 定期更新：保持文件與程式碼同步

### 關於 Python 編碼

**Windows 平台常見問題**：
- 預設編碼是 CP950（Big5）
- 需要明確設定 UTF-8
- 解決方案：
  ```python
  # 1. sys.stdout wrapper
  sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

  # 2. 日誌系統設定
  logging.basicConfig(..., encoding='utf-8')

  # 3. 檔案操作明確指定
  with open(file, 'w', encoding='utf-8') as f:
  ```

---

#### 📅 討論記錄

### 2025-12-06 (五) - base.py 移除與 v4.0 升級

#### 背景
完成統一文字格式 v4.0 設計後，需要移除舊的 base.py 架構。

#### 完成事項
1. ✅ 刪除所有 base.py 檔案
   - `dev/f14_package/base.py`
   - `modules/TEMP/base.py`
   - `dev/f14_package/f14_fetcher_dev_claude.py`

2. ✅ 更新所有範本到 v4.0
   - `dev/_template.py`
   - `dev/_template_spec.md`
   - `dev/f14_package/_template.py`
   - `dev/f14_package/f14_fetcher_dev.py`

3. ✅ 更新所有規格書
   - `dev/f14_package/f14_fetcher_spec.md`
   - 移除 base.py 引用
   - 更新為統一文字格式範例

4. ✅ 創建/更新文件
   - `dev/README.md` - 開發目錄說明
   - `README.md` - 專案入口更新

#### 驗證結果
- ✅ dev/ 目錄：無任何檔案引用 base.py
- ✅ modules/ 目錄：無任何檔案引用 base.py
- ✅ 所有模組使用統一文字格式

---

### 2025-12-06 (五) - 文件系統完善與討論記錄優化

#### 背景
完成 base.py 移除後，需要建立完整的開發文件系統，並優化跨討論組記錄檔。

#### 完成事項
1. ✅ 創建 `dev/README.md` 開發指南
   - 完整開發流程（5 步驟）
   - 統一文字格式 v4.0 規範說明
   - 程式碼範本骨架
   - 常見錯誤與解決方法（4 大錯誤）
   - 版本變更說明（v3.x → v4.0）
   - F01/F14 範例參考

2. ✅ 更新根目錄 `README.md`
   - 新增 dev/README.md 連結
   - 更新文件導覽章節
   - 更新文件關係圖
   - 簡化開發流程為 5 步驟
   - 新增四大核心規範速查

3. ✅ 優化 `Claude跨討論組_log.md` (v1.0 → v2.0)
   - 重新組織章節結構
   - 新增專案狀態追蹤表（模組進度、文件完成度）
   - 新增重要決策記錄章節
   - 新增經驗分享章節（v4.0 優缺點、文件撰寫、Python 編碼）
   - 新增下一步計畫（短/中/長期）
   - 建立討論記錄範本

4. ✅ 文件命名決策
   - 評估 4 種方案（保持原名、DEVELOPMENT.md、DEV_GUIDE.md、README_dev.md）
   - 決定保持 `dev/README.md` 不變（業界標準）

#### 技術重點

**dev/README.md 核心內容**：
- 目錄結構說明
- 快速開始指南（必讀文件、範例參考、範本使用）
- 6 步驟開發流程（創建→複製→填寫→實作→測試→驗收）
- 統一文字格式規範與範例
- 常見錯誤對照表（錯誤 vs. 正確寫法）
- 測試提示與程式碼品質建議

**文件組織架構**：
```
README.md (專案入口)
    ├─ 使用專案
    ├─ 開發模組 → dev/README.md ⭐
    │              → 共同開發規範書_V1.md
    │              → _template.py / _template_spec.md
    ├─ 範例參考 → F01/F14 程式碼與規格書
    └─ Claude Code → CLAUDE_CONFIG.md
```

#### 決策

**保持 dev/README.md 命名的理由**：
1. 業界標準慣例（GitHub 自動顯示）
2. 路徑即可區分（根目錄 vs. dev/）
3. IDE 導航友善
4. 符合開源專案慣例

**討論記錄檔升級重點**：
- 從單純記錄升級為知識庫
- 新增狀態追蹤（一目了然專案進度）
- 新增決策記錄（了解為什麼這樣做）
- 新增經驗分享（避免重複踩坑）

#### 文件完成狀態
- ✅ README.md（根目錄） - 版本 4.0.0
- ✅ dev/README.md - 版本 4.0
- ✅ Claude跨討論組_log.md - 版本 2.0
- ✅ 所有文件交叉引用已更新

---

### 2025-12-04 (三) - 專案建立與初始設定

#### 背景
建立 Taifex 期貨資料自動抓取系統，統一管理多個資料來源。

#### 完成事項
1. ✅ 建立專案結構
2. ✅ 實作 run.py 主控程式
3. ✅ 完成 F01 模組（台指期外資未平倉）
4. ✅ 設定 UTF-8 編碼處理
5. ✅ 建立共同開發規範書

#### 技術亮點
- 動態模組載入
- 模組快取機制
- 自訂輸出格式轉換
- 完整中文支援

---

## 📌 給 Claude 的指示範本

### 新增討論記錄

```markdown
### YYYY-MM-DD - [主題名稱]

#### 背景
[簡述情境]

#### 完成事項
1. ✅ [完成項目 1]
2. ✅ [完成項目 2]

#### 決策
- [重要決定 1]
- [重要決定 2]

#### 待處理
- [ ] [待辦事項 1]
- [ ] [待辦事項 2]
```

---

**文件版本**: 2.0
**最後更新**: 2025-12-06
**維護者**: Claude Code Assistant
